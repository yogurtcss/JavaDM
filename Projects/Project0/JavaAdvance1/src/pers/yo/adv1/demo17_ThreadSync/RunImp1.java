package pers.yo.adv1.demo17_ThreadSync;

/*
------------------------------------------------------------
1.åŒæ­¥ä»£ç å—ï¼šsynchronize   /ËˆsÉªÅ‹.krÉ™.naÉªz/
synchronizedå…³é”®å­—å¯ç”¨äºæ–¹æ³•ä¸­çš„æŸä¸ªåŒºå—ä¸­ï¼Œè¡¨ç¤ºåªå¯¹è¿™ä¸ªåŒºå—çš„èµ„æºè¿›è¡Œ ã€äº’æ–¥è®¿é—®ã€‘ï¼Œæ ¼å¼ä¸ºï¼š

synchronized(åŒæ­¥é”syncObject){ // å¿…é¡»è·å¾—äº†syncObjecé”çš„çº¿ç¨‹ æ‰èƒ½æ‰§è¡Œsynchronizedå—çš„ä»£ç 
    //éœ€è¦åŒæ­¥æ“ä½œçš„ä»£ç 
}

åŒæ­¥é”(ä¹Ÿç§° å¯¹è±¡é” æˆ– å¯¹è±¡ç›‘è§†å™¨)ï¼š
å¯¹è±¡çš„åŒæ­¥é”åªæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œå¯ä»¥æƒ³è±¡ä¸º åœ¨å¯¹è±¡ä¸Šæ ‡è®°äº†ä¸€ä¸ªé”
1.é”å¯¹è±¡ å¯ä»¥æ˜¯ä»»æ„çš„å¯¹è±¡ï¼›//å¯ä»¥æ˜¯æŸä¸ªç±»çš„å®ä¾‹ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸä¸ªç±»
ä½†å¿…é¡»åœ¨ Runnableæ¥å£å®ç°ç±»ä¸­ ä¸” åœ¨é‡å†™çš„run()æ–¹æ³•å¤– åˆ›å»ºé”å¯¹è±¡Object
è¿™æ ·ç¡®ä¿æ­¤é”å¯¹è±¡æ˜¯ ã€å…¨å±€ã€‘çš„ï¼Œä½¿å¾— å¤šä¸ªçº¿ç¨‹å¯¹è±¡ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼›æ ¼å¼å¦‚ä¸‹ï¼š
Object obj = new Object(); //è¿™ä¹ˆç®€å•ï¼ï¼

â–² è‹¥åœ¨é‡å†™çš„run()æ–¹æ³•ä¸­åˆ›å»ºé”å¯¹è±¡Objectï¼Œåˆ™æ¯ä¸ªä¸åŒçš„çº¿ç¨‹éƒ½ä¼šåˆ›å»ºä¸åŒçš„é”å¯¹è±¡ï¼ï¼
å¦‚æ­¤ï¼Œè¿™å †çº¿ç¨‹å¯¹è±¡å°±ä¸æ˜¯ä½¿ç”¨åŒä¸€æŠŠé”äº†ï¼ï¼

2.å¤šä¸ªçº¿ç¨‹å¯¹è±¡ å¿…é¡»ä½¿ç”¨åŒä¸€æŠŠé”
æ³¨ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œæœ€å¤šå…è®¸ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰åŒæ­¥é”ï¼š
è°(å“ªä¸ªçº¿ç¨‹)æ‹¿åˆ°åŒæ­¥é”ï¼Œå°±è¿›å…¥è°(å“ªä¸ªçº¿ç¨‹)çš„ä»£ç å—ï¼›è€Œå…¶ä»–æ²¡æ‹¿åˆ°åŒæ­¥é”çš„çº¿ç¨‹åªèƒ½åœ¨å¤–ç­‰ç€(BLOCKED)

â–² åŒæ­¥ä¸­çš„çº¿ç¨‹ï¼šè‹¥æœªæ‰§è¡Œå®Œæ¯•åˆ™ä¸ä¼šé‡Šæ”¾ã€å½’è¿˜é”(æŠŠé”å½’è¿˜ç»™åŒæ­¥ä»£ç å—ï¼›å…¶ä½™çº¿ç¨‹ç»§ç»­è¿›åŒæ­¥ä»£ç å—å‰çº¿ æŠ¢è¿™é”)ï¼›
åŒæ­¥å¤–çš„çº¿ç¨‹æ²¡æœ‰é” è¿›ä¸å»åŒæ­¥


------------------------------------------------------------
3.Locké”(ä¹Ÿç§°) ğŸ”’
java.util.concurrent.locks.Lockæ¥å£
åŠ é”å’Œé‡Šæ”¾é” å„æœ‰å•ç‹¬çš„è°ƒç”¨æ–¹æ³•
public void lock()ï¼šåŠ åŒæ­¥é”
public void unlock()ï¼šé‡Šæ”¾åŒæ­¥é”

ä½¿ç”¨Lockæ¥å£çš„å®ç°ç±» ReentrantLock
ReentrantLock å³ re(é‡,å†æ¬¡) - entrant(è¿›å…¥) - lock(é”)ï¼Œ å³é‡å…¥é”

ReentrantLock é‡å…¥é”ï¼šæ”¯æŒé‡å…¥æ€§ï¼Œ
è¡¨ç¤ºèƒ½å¤Ÿå¯¹å…±äº«èµ„æºèƒ½å¤Ÿé‡å¤åŠ é”ï¼Œå³ï¼šè‹¥å½“å‰çº¿ç¨‹(åœ¨æŸæ¬¡)è·å–è¯¥é”å¹¶é‡Šæ”¾é”åï¼Œå†æ¬¡è·å–(å³ åˆä¸€æ¬¡æŠ¢é”æ—¶)ä¸ä¼šè¢«é˜»å¡ã€‚

ä½¿ç”¨æ­¥éª¤ï¼š
1.åœ¨æˆå‘˜ä½ç½®(ä½¿ç”¨ä¸Šè½¬å‹å†™æ³•ï¼Œå·¦æ¥å£ å³å®ç°ç±»)åˆ›å»ºä¸€ä¸ªReentrantLockå¯¹è±¡ï¼Œ
å› ä¸ºç¬¬2ã€3æ­¥è¦è°ƒç”¨Lockæ¥å£ä¸­çš„æ–¹æ³•ï¼Œæ‰€ä»¥å°†æ­¤å¯¹è±¡ä¸Šè½¬å‹ä¸º Lockæ¥å£ï¼Œæ ¼å¼ï¼š
Lock l = new ReentrantLock();

2.åœ¨å¯èƒ½å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ä»£ç ã€å‰ã€‘ï¼Œè°ƒç”¨ Lockæ¥å£çš„ lock()æ–¹æ³•ï¼Œè·å–é”
3.åœ¨å¯èƒ½å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ä»£ç ã€åã€‘ï¼Œè°ƒç”¨Lockæ¥å£çš„ unlock()æ–¹æ³•ï¼Œé‡Šæ”¾é”


*  */


import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

public class RunImp1 implements Runnable { //RunImpå…¨ç§°ä¸º Runnable Implements 1
    private int ticket = 100;

    Lock l = new ReentrantLock(); //ä¸Šè½¬å‹å†™æ³•ï¼Œå› ä¸ºè¦ç”¨åˆ°Lockæ¥å£ä¸­çš„æ–¹æ³•


    // ä½¿ç”¨åŒæ­¥é”(å¯¹è±¡æ‰€)
//    Object syncObj = new Object(); //åŒæ­¥é”
//    public void run(){
//        while(true){ //æ•´ä¸ªæ­»å¾ªç¯
//            synchronized( syncObj ){ //åŒæ­¥ä»£ç å—
//                if( ticket>0 ){
//                    try{
//                        Thread.sleep( 10 );
//                    }
//                    catch( InterruptedException e ){
//                        e.printStackTrace();
//                    }
//                    System.out.println( Thread.currentThread().getName()+"ï¼šæ­£åœ¨å–ç¬¬ "+ticket+" å¼ ç¥¨å—·ï¼" );
//                    ticket--;
//                }
//            }
//        }
//    }

    // ä½¿ç”¨Locké”
    public void run(){

        while(true){ //æ•´ä¸ªæ­»å¾ªç¯

            l.lock(); //2.åœ¨å¯èƒ½å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ä»£ç ã€å‰ã€‘ï¼Œè°ƒç”¨ Lockæ¥å£çš„ lock()æ–¹æ³•ï¼Œè·å–é”
            if( ticket>0 ){
                try{
                    Thread.sleep( 10 );
                    System.out.println( Thread.currentThread().getName()+"ï¼šæ­£åœ¨å–ç¬¬ "+ticket+" å¼ ç¥¨å—·ï¼" );
                    ticket--;
                }
                catch( InterruptedException e ){
                    e.printStackTrace();
                }
                finally{
                    l.unlock(); //3.åœ¨å¯èƒ½å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ä»£ç ã€åã€‘ï¼Œè°ƒç”¨Lockæ¥å£çš„ unlock()æ–¹æ³•ï¼Œé‡Šæ”¾é”
                    //æ— è®ºç¨‹åºæ˜¯å¦å¼‚å¸¸ï¼Œéƒ½ä¼šé‡Šæ”¾é”
                }

            }
        }
    }
}
